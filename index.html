<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voice Whiteboard ‚Äî Draw, Type, Speak</title>
<style>
  :root{
    --bg:#0e0f12; --panel:#171920; --ink:#e8e8ea; --muted:#9aa0a6;
    --accent:#4f46e5; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .app{display:grid;grid-template-rows:auto 1fr; height:100%;}
  header{
    display:flex; gap:.5rem; align-items:center; padding:.6rem .8rem;
    background:linear-gradient(180deg,var(--panel),#12141a); border-bottom:1px solid #232632;
    position:sticky; top:0; z-index:5;
  }
  header h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.2px}
  .spacer{flex:1}
  button, .chip{
    background:#222534; color:var(--ink); border:1px solid #2c3042; border-radius:12px;
    padding:.45rem .65rem; cursor:pointer; display:inline-flex; align-items:center; gap:.5rem;
    transition:transform .05s ease, background .2s ease, border-color .2s ease;
  }
  button:hover{background:#262a3c}
  button:active{transform:translateY(1px)}
  button[disabled]{opacity:.6; cursor:not-allowed}
  .mic.on{background:#262a3c; border-color:#3d425b; box-shadow:0 0 0 2px rgba(79,70,229,.25) inset}
  .toolbar{display:flex; gap:.4rem; align-items:center; flex-wrap:wrap}
  .label{color:var(--muted); font-size:12px}
  input[type="range"]{accent-color:var(--accent)}
  .board-wrap{
    position:relative; height:100%; overflow:hidden;
  }
  canvas#board{position:absolute; inset:0; width:100%; height:100%; cursor:crosshair}
  /* Notes layer */
  .notes-layer{position:absolute; inset:0; pointer-events:none}
  .note{
    position:absolute; min-width:120px; max-width:280px; padding:.5rem .6rem .6rem .6rem;
    background:#202432; color:#e9eaf0; border:1px solid #30364a; border-radius:10px;
    box-shadow:0 6px 20px rgba(0,0,0,.35);
    pointer-events:auto; user-select:none;
  }
  .note textarea{
    width:100%; height:100%; border:0; outline:0; background:transparent; color:inherit; resize:none;
    font:14px/1.35 ui-sans-serif,system-ui; caret-color:#fff;
  }
  .note .handle{position:absolute; top:6px; right:8px; font-size:12px; color:var(--muted); cursor:grab}
  .note .meta{position:absolute; bottom:6px; left:10px; font-size:11px; color:#9aa0a6}
  .note.selected{outline:2px solid #7c83ff}
  /* Color dots */
  .color-dots{position:absolute; right:12px; bottom:12px; display:flex; gap:.5rem; z-index:4}
  .dot{
    width:30px; height:30px; border-radius:50%; border:2px solid #2f3347; cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,.35);
  }
  .dot[data-color="black"]{background:#101216}
  .dot[data-color="red"]{background:#ef4444}
  .dot[data-color="green"]{background:#22c55e}
  .dot[data-color="blue"]{background:#3b82f6}
  .dot[data-color="white"]{background:#ffffff; border:2px solid #aaa;}
  .dot.active{outline:3px solid rgba(255,255,255,.25)}
  /* Board background picker */
  #boardBgPicker{
    position:absolute;
    right:12px;
    bottom:60px;
    z-index:5;
  }
  /* Custom context menu */
  .ctx{
    position:absolute; background:#1b1f2d; border:1px solid #2b3150; border-radius:12px; padding:.35rem;
    min-width:220px; box-shadow:0 12px 26px rgba(0,0,0,.45); z-index:10; display:none;
  }
  .ctx button{
    width:100%; justify-content:flex-start; border-radius:10px; padding:.55rem .65rem; background:transparent;
  }
  .ctx button:hover{background:#232943}
  .status{color:var(--muted); font-size:12px}
  /* Notes list drawer */
  .drawer{
    position:absolute; top:12px; right:12px; background:#141826; border:1px solid #242a44; border-radius:14px;
    max-height:60%; width:260px; overflow:auto; z-index:6; box-shadow:0 10px 30px rgba(0,0,0,.45)
  }
  .drawer header{position:sticky; top:0; background:#141826; padding:.5rem .7rem; border-bottom:1px solid #242a44}
  .drawer .items{padding:.3rem .3rem .6rem}
  .drawer .item{
    display:flex; gap:.5rem; align-items:flex-start; padding:.45rem .5rem; border-radius:10px; border:1px solid transparent;
  }
  .drawer .item:hover{background:#171c2e; border-color:#232a4a}
  .drawer .item .ts{color:var(--muted); font-size:11px}
  .drawer .item .txt{white-space:pre-wrap}
  .hidden{display:none}
  /* Small screens */
  @media (max-width:800px){
    .drawer{width:72vw}
    header{flex-wrap:wrap}
  }
  /* Hide system menu on canvas right-click */
  #board { -webkit-touch-callout:none; -webkit-user-select:none; -webkit-tap-highlight-color: transparent; }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>üé§ Voice Whiteboard</h1>
    <div class="spacer"></div>
    <div class="toolbar">
      <span class="label">Brush</span>
      <input id="size" type="range" min="1" max="40" value="5" />
      <button id="undo" title="Undo (Ctrl+Z)">‚Ü∂ Undo</button>
      <button id="redo" title="Redo (Ctrl+Y)">‚Ü∑ Redo</button>
      <button id="eraser" title="Eraser (E)">ü©π Eraser</button>
      <button id="save" title="Export PNG">üíæ PNG</button>
      <button id="clear" class="danger" title="Clear Board">üßπ Clear</button>
      <button id="toggleDrawer" title="Show Notes">üóíÔ∏è Notes</button>
      <button id="mic" class="mic" title="Start/Stop Voice Notes">üéô Start</button>
      <span id="micState" class="status">Mic: idle</span>
    </div>
  </header>

  <div class="board-wrap" id="wrap">
    <canvas id="board"></canvas>
    <div class="notes-layer" id="notesLayer"></div>

    <!-- Color dots -->
    <div class="color-dots" id="dots">
      <div class="dot" data-color="black" title="Black"></div>
      <div class="dot" data-color="red"   title="Red"></div>
      <div class="dot" data-color="green" title="Green"></div>
      <div class="dot" data-color="blue"  title="Blue"></div>
      <div class="dot" data-color="white" title="White"></div>
    </div>

    <!-- Board background color -->
    <input type="color" id="boardBgPicker" value="#0d0f14" title="Change Board Background" />

    <!-- Custom context menu -->
    <div class="ctx" id="ctx">
      <button data-act="addNote">‚ûï Add Text Note</button>
      <button data-act="toggleEraser">ü©π Toggle Eraser</button>
      <button data-act="undo">‚Ü∂ Undo</button>
      <button data-act="redo">‚Ü∑ Redo</button>
      <button data-act="save">üíæ Export PNG</button>
      <button data-act="clear" style="color:#ef4444">üßπ Clear Board</button>
    </div>

    <!-- Notes drawer -->
    <aside class="drawer hidden" id="drawer">
      <header class="drawer-head">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>Notes</strong>
          <button id="closeDrawer">‚úï</button>
        </div>
      </header>
      <div class="items" id="notesList"></div>
    </aside>
  </div>
</div>

<script>
(function(){
  const wrap = document.getElementById('wrap');
  const canvas = document.getElementById('board');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const dots = document.getElementById('dots');
  const size = document.getElementById('size');
  const undoBtn = document.getElementById('undo');
  const redoBtn = document.getElementById('redo');
  const eraserBtn = document.getElementById('eraser');
  const saveBtn = document.getElementById('save');
  const clearBtn = document.getElementById('clear');
  const ctxMenu = document.getElementById('ctx');
  const boardBgPicker = document.getElementById('boardBgPicker');

  const notesLayer = document.getElementById('notesLayer');
  const drawer = document.getElementById('drawer');
  const notesList = document.getElementById('notesList');
  const toggleDrawer = document.getElementById('toggleDrawer');
  const closeDrawer = document.getElementById('closeDrawer');

  const micBtn = document.getElementById('mic');
  const micState = document.getElementById('micState');

  let color = 'black';
  let boardBgColor = '#0d0f14';
  let erasing = false;
  let drawing = false;
  const history = [];
  const future = [];
  const MAX_HISTORY = 25;
  const notes = [];

  function resizeCanvas(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = wrap.getBoundingClientRect();
    const w = Math.floor(rect.width);
    const h = Math.floor(rect.height);
    const img = ctx.getImageData(0,0,canvas.width||1,canvas.height||1);
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.fillStyle = boardBgColor;
    ctx.fillRect(0,0,w,h);
    if(img.width && img.height){
      const tmp = document.createElement('canvas');
      tmp.width = img.width; tmp.height = img.height;
      tmp.getContext('2d').putImageData(img,0,0);
      ctx.drawImage(tmp,0,0,w,h);
    }
  }
  window.addEventListener('resize', () => { resizeCanvas(); saveStateDebounced(); });

  function pushHistory(){
    if(history.length >= MAX_HISTORY) history.shift();
    history.push(canvas.toDataURL());
    future.length = 0;
    updateUndoRedo();
  }
  function restoreFrom(dataURL){
    const img = new Image();
    img.onload = ()=>{
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img,0,0,canvas.width/ (window.devicePixelRatio||1), canvas.height/ (window.devicePixelRatio||1));
      saveStateDebounced();
    };
    img.src = dataURL;
  }
  function updateUndoRedo(){
    undoBtn.disabled = history.length < 1;
    redoBtn.disabled = future.length < 1;
  }

  function startDraw(x,y){
    drawing = true;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.lineWidth = +size.value;
    ctx.strokeStyle = erasing ? boardBgColor : color;
    ctx.beginPath();
    ctx.moveTo(x,y);
  }
  function moveDraw(x,y){
    if(!drawing) return;
    ctx.lineTo(x,y);
    ctx.stroke();
  }
  function endDraw(){
    if(!drawing) return;
    drawing = false;
    ctx.closePath();
    pushHistory();
    saveStateDebounced();
  }

  function getRelPos(ev){
    const rect = canvas.getBoundingClientRect();
    return {x:(ev.clientX - rect.left), y:(ev.clientY - rect.top)};
  }

  canvas.addEventListener('pointerdown', (e)=>{
    if(e.button === 2) return;
    ctxMenu.style.display = 'none';
    canvas.setPointerCapture(e.pointerId);
    const {x,y} = getRelPos(e);
    startDraw(x,y);
  });
  canvas.addEventListener('pointermove', (e)=>{
    if(!drawing) return;
    const {x,y} = getRelPos(e);
    moveDraw(x,y);
  });
  window.addEventListener('pointerup', (e)=>{
    if(drawing){ endDraw(); try{ canvas.releasePointerCapture(e.pointerId);}catch{} }
  });

  canvas.addEventListener('contextmenu', (e)=>{
    e.preventDefault();
    ctxMenu.style.display = 'block';
    ctxMenu.style.left = e.clientX+'px';
    ctxMenu.style.top = e.clientY+'px';
  });
  window.addEventListener('click', ()=> ctxMenu.style.display='none');

  ctxMenu.addEventListener('click', (e)=>{
    const act = e.target?.dataset?.act;
    if(!act) return;
    ctxMenu.style.display='none';
    if(act==='addNote') createNoteAtCenter();
    if(act==='toggleEraser') toggleEraser();
    if(act==='undo') doUndo();
    if(act==='redo') doRedo();
    if(act==='save') exportPNG();
    if(act==='clear') clearBoard();
  });

  undoBtn.addEventListener('click', doUndo);
  redoBtn.addEventListener('click', doRedo);
  eraserBtn.addEventListener('click', toggleEraser);
  saveBtn.addEventListener('click', exportPNG);
  clearBtn.addEventListener('click', clearBoard);

  function doUndo(){
    if(history.length < 1) return;
    const cur = canvas.toDataURL();
    future.push(cur);
    const prev = history.pop();
    restoreFrom(prev);
    updateUndoRedo();
  }
  function doRedo(){
    if(future.length < 1) return;
    const cur = canvas.toDataURL();
    history.push(cur);
    const next = future.pop();
    restoreFrom(next);
    updateUndoRedo();
  }
  function toggleEraser(){
    erasing = !erasing;
    eraserBtn.classList.toggle('on', erasing);
    eraserBtn.textContent = erasing ? 'ü©π Eraser (ON)' : 'ü©π Eraser';
  }
  function exportPNG(){
    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href=url; a.download='whiteboard.png'; a.click();
  }
  function clearBoard(){
    const r = canvas.getBoundingClientRect();
    ctx.fillStyle = boardBgColor;
    ctx.fillRect(0,0,r.width,r.height);
    pushHistory();
    saveStateDebounced();
  }

  function setActiveDot(c){
    color = c; erasing=false; eraserBtn.classList.remove('on'); eraserBtn.textContent='ü©π Eraser';
    dots.querySelectorAll('.dot').forEach(d=>d.classList.toggle('active', d.dataset.color===c));
  }
  dots.addEventListener('click', (e)=>{
    const d = e.target.closest('.dot'); if(!d) return;
    setActiveDot(d.dataset.color);
  });
  setActiveDot('black');

  // background picker
  boardBgPicker.addEventListener('input', (e)=>{
    boardBgColor = e.target.value;
    clearBoard();
  });

  // Init
  resizeCanvas();
  clearBoard();

})();
</script>
</body>
</html>
